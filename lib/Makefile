.POSIX:
CC      = cc
CFLAGS 	= -std=c99 -fpic -O2 -Wall -Wextra -pedantic -I include
LD      = $(CC)
LDFLAGS = -shared
AR      = ar
ARFLAGS = rcs

INSTALL         = install -D
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA    = $(INSTALL) -m 644

BUILDDIR   = build
DESTDIR    =
PREFIX     = /usr/local
INCLUDEDIR = /include
LIBDIR     = /lib
prefix     = $(DESTDIR)$(PREFIX)
includedir = $(prefix)$(INCLUDEDIR)
libdir     = $(prefix)$(LIBDIR)

LIBNAME = iuab

TARGET_STATIC = lib$(LIBNAME).a
TARGET_SHARED = lib$(LIBNAME).so

OBJECTS = src/buffer.o src/compiler.o src/errors.o src/lexer.o src/op.o \
	src/token.o src/vm.o

all: $(BUILDDIR)/$(TARGET_STATIC) $(BUILDDIR)/$(TARGET_SHARED)

$(BUILDDIR):
	@echo "  MKDIR   $@"
	@mkdir -p $@

$(BUILDDIR)/$(TARGET_STATIC): $(BUILDDIR) $(OBJECTS)
	@echo "  AR      $@"
	@$(AR) $(ARFLAGS) $@ $(OBJECTS)

$(BUILDDIR)/$(TARGET_SHARED): $(BUILDDIR) $(OBJECTS)
	@echo "  LD      $@"
	@$(LD) $(LDFLAGS) -o $@ $(OBJECTS)

.c.o:
	@echo "  CC      $@"
	@$(CC) $(CFLAGS) -c -o $@ $<

install: install_static install_shared install_headers

install_static: $(BUILDDIR)/$(TARGET_STATIC)
	@echo "  INSTALL $(libdir)/$(TARGET_STATIC)"
	@$(INSTALL_DATA) $< $(libdir)/$(TARGET_STATIC)

install_shared: $(BUILDDIR)/$(TARGET_SHARED)
	@echo "  INSTALL $(libdir)/$(TARGET_SHARED)"
	@$(INSTALL_PROGRAM) $< $(libdir)/$(TARGET_SHARED)

install_headers:
	@echo "  CP      $(includedir)/$(LIBNAME)"
	@cp -r include/$(LIBNAME) $(includedir)

uninstall: uninstall_static uninstall_shared uninstall_headers

uninstall_static:
	@echo "  RM      $(libdir)/$(TARGET_STATIC)"
	@rm -f $(libdir)/$(TARGET_STATIC)

uninstall_shared:
	@echo "  RM      $(libdir)/$(TARGET_SHARED)"
	@rm -f $(libdir)/$(TARGET_SHARED)

uninstall_headers:
	@echo "  RM      $(includedir)/$(LIBNAME)"
	@rm -rf $(includedir)/$(LIBNAME)

depend:
	@for file in src/*.c; do \
		$(CC) $(CFLAGS) -MM -MT "$${file%.c}.o" "$$file"; \
	done

clean:
	@echo "  CLEAN"
	@rm -rf $(BUILDDIR) src/*.o

# Dependencies (generated by `make depend`)
src/buffer.o: src/buffer.c include/iuab/buffer.h include/iuab/errors.h
src/compiler.o: src/compiler.c include/iuab/compiler.h \
 include/iuab/buffer.h include/iuab/errors.h include/iuab/lexer.h \
 include/iuab/token.h include/iuab/op.h
src/errors.o: src/errors.c include/iuab/errors.h
src/lexer.o: src/lexer.c include/iuab/lexer.h include/iuab/token.h
src/op.o: src/op.c include/iuab/op.h
src/token.o: src/token.c include/iuab/token.h
src/vm.o: src/vm.c include/iuab/vm.h include/iuab/errors.h \
 include/iuab/errors.h include/iuab/op.h
